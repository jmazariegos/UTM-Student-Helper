

<!DOCTYPE html>
<html>
   <head>
      <title>Our UTM</title>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <script src="https://sdk.amazonaws.com/js/aws-sdk-2.2.32.min.js"></script> 
      <script src="Website/jquery-3.3.1.min.js"></script>
      <script src="Website/client.js"></script>
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
      <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
      <link rel="stylesheet" type="text/css" href="Website/layout.css">

      <!-- Script for timetable -->
      <script src="./Scripts/reloadTimetable.js"></script>

      <!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous"> -->
      <!-- Move to Client.js -->
<!--  -->
      <script type="text/javascript">
         $(document).ready( function () {
            $('form').submit( function () {
               var formdata = $(this).serialize();
               $.ajax({
                  type: "POST",
                  url: "",
                  data: formdata
               });
               return false;
            });
         });
      </script>



      <script> 
         //request.open('GET', 'https://github.com/jessly5/301tsv/blob/master/timeTable.json', true);
         //xmlhttp https://www.w3schools.com/js/tryit.asp?filename=tryjson_http
         //document.getElementById("course-list").innerHTML = JSON.stringify($courses[0].code);
         
         // var url = "./data/timeTable.json";
         
         // $.getJSON(url, function(data) {
         //    console.log(data); //this writes to the console, and I think we need this request to access data
            
         //    var days = {"SU":0, "MO":1, "TU":2, "WE":3, "TH":4, "FR":5, "SA":6};
         //    var timetable = document.getElementById("timetable");
            
         //    var courses = data['courses']; //get value of this key
         //    var course_list_len = courses.length;
            
         //    for (i=0; i < course_list_len; i++){ //go through each course
               
         //       var code = courses[i].code;
         //       var ses = courses[i].session;
         //       var name = courses[i].name;
         //       var description = courses[i].description;
               
         //       var lec = courses[i].lectures[0]; //0 since we only have once tuple in the list of lectures
         //       var section = lec.section;
         //       var time = lec.timings;
         //       for(j=0; j < time.length; j++) { //go through each lecture
         //          var d = time[j][0];
         //          var day_index = days[d];
         //          var start = time[j][1];
         //          var end = time[j][2];
         //          for (var k = 1, row; row = timetable.rows[k]; k++) { //1 because row of table headers is 0
         //             for (var m = 1, col; col = row.cells[m]; m++) {
         //                if (m == day_index){                                           
         //                   var new_node = "<div class=\"class\"><b>Lecture: </b>"+code+"<br/>"+start+"-"+end+"<\div><br/><div class=\"classinfo\"><b>Name</b>: "+name+"<br/><b>Session</b>: "+section+"<br/><b>Info</b>: "+description+"<\div>";
         //                   col.insertAdjacentHTML('beforeend', new_node);                       
         //                }
         //             }  
         //          }
         //       }
               
         //       var tutorials = courses[i].tutorials[0];
         //       time = tutorials.timings;
         //       section = tutorials.section;
               
         //       for(j=0; j < time.length; j++) { //go through each tutorial
         //          var d = time[j][0]; 
         //          var day_index = days[d];
         //          var start = time[j][1];
         //          var end = time[j][2];
         //          for (var k = 1, row; row = timetable.rows[k]; k++) { //1 because row of date names is 0
         //             for (var m = 1, col; col = row.cells[m]; m++) {
         //                if (m == day_index){                                           
         //                   var new_node = "<div class=\"class\"><b>Tutorial: </b>"+code+"<br/>"+start+"-"+end+"<\div><br/><div class=\"classinfo\"><b>Name</b>: "+name+"<br/><b>Session</b>: "+section+"<br/><b>Info</b>: "+description+"<\div>";
         //                   col.insertAdjacentHTML('beforeend', new_node);                       
         //                }
         //             }  
         //          }
         //       }
               
         //       var practicals = courses[i].practicals[0];
         //       time = practicals.timings;
         //       section = practicals.section;
               
         //       for(j=0; j < time.length; j++) { //go through each practical
         //          var d = time[j][0]; 
         //          var day_index = days[d];
         //          var start = time[j][1];
         //          var end = time[j][2];
         //          for (var k = 1, row; row = timetable.rows[k]; k++) { //1 because row of date names is 0
         //             for (var m = 1, col; col = row.cells[m]; m++) {
         //                if (m == day_index){                                           
         //                   var new_node = "<div class=\"class\"><b>Practical: </b>"+code+"<br/>"+start+"-"+end+"<\div><br/><div class=\"classinfo\"><b>Name</b>: "+name+"<br/><b>Session</b>: "+section+"<br/><b>Info</b>: "+description+"<\div>";
         //                   col.insertAdjacentHTML('beforeend', new_node);                       
         //                }
         //             }  
         //          }
         //       }
               
         //    }        
         // });
      </script>
   </head>
   <body>
      <!-- Login page
         ----------------------------------------------------------
         -->
      <div class="navbar">
         <nav class="navbar navbar-inverse navbar-fixed-top">
            <img id="logo" src="Website/logo.jpeg" width="30" height="30" class="d-inline-block align-top" alt="">
            <!-- <img src = ></img> -->
         </nav>
      </div>
      <div class="Body">
      <div id="login">
         <!-- Login stuff  -->
         <div id="cont">
            <div id="quote">
               <h1>Let us share Our Work and Our Schedules.<br>
                  This is not <strong>YOUR UTM</strong> nor <strong>MY UTM.</strong><br>
                  THIS IS <Strong>OUR UTM.</Strong>
               </h1>
            </div>
            <div id="in">
               <h2>Login:</h2>
               <br>
               <table>
                  <tr>
                     <td>
                        E-Mail:
                     </td>
                     <td>
                        <input id="lemail" type="Email" required><br>
                     </td>
                  </tr>
                  <tr>
                     <td>
                        Password:
                     </td>
                     <td>
                        <input id="lpass" type="password" required><br>
                     </td>
                  </tr>
               </table>
               <br>
               <button id="loginButton" type="submit" class="btn btn-default">Login<br></button><br>
               <br>
               <div class="btn-toolbar">
                  <button id="Reglink" class="btn btn-primary" data-toggle="modal" data-target="#reg">Register<br></button>
                  <button id="Forgot" class="btn btn-primary" data-toggle="modal" data-target="#reset">Forgot Password<br></button>
               </div>
            </div>
         </div>
         <!-- </form> -->
      </div>
      <!-- Regstration page
         ----------------------------------------------------------
         -->
      <div id="reg" class="modal fade" role="dialog">
         <div class="modal-dialog">
            <div class="modal-content">
               <div class="modal-header">
                  <h1>Registration:</h1>
               </div>
               <div class="modal-body">
                  <table>
                     <tr>
                        <td>
                           User Name:
                        </td>
                        <td>
                           <input id="ruserid" name="userid" required><br>
                        </td>
                     </tr>
                     <tr>
                        <td>
                           E-Mail:
                        </td>
                        <td>
                           <input id="remail" type="Email" name="Email" required><br>
                        </td>
                     </tr>
                     <tr>
                        <td>
                           Password:
                        </td>
                        <td>
                           <input id="rpass1" type="password" required><br>
                        </td>
                     </tr>
                     <tr>
                        <td>
                           Confirm Password:
                        </td>
                        <td>             
                           <input id="rpass2" type="password" required><br>
                        </td>
                     </tr>
                  </table>
               </div>
               <div class="modal-footer">
                  <button id="regButton" type="submit" class="btn btn-primary">Submit<br></button>
                  <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
               </div>
            </div>
         </div>
      </div>
      <!-- Reset page
         ----------------------------------------------------------
         -->
      <div id="reset" class="modal fade" role="dialog">
         <div class="modal-dialog">
            <div class="modal-content">
               <div class="modal-header">
                  <h1>Forgot Password:</h1>
               </div>
               <div class="modal-body">
                  Email:
                  <input id="resemail" type='Email' required>
               </div>
               <div class="modal-footer">
                  <div class="btn-toolbar">
                     <button id="resetButton" type="submit" class="btn btn-primary">Submit<br></button>
                     <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                  </div>
               </div>
            </div>
         </div>
      </div>
      <!-- Home page
         ----------------------------------------------------------
         -->
      <div class="" id="sidebar">
         <ul class="nav nav-pills nav-stacked">
            <li id='side-home'      class="active nav-link"> 
               <a href="#" onclick="return false;">Home<br></a>
            </li>
            <li id="side-calendar"  class="active nav-link"> 
               <a href="#" onclick="return false;">Calendar<br></a>
            </li>
            <li id="side-notes"     class="active nav-link"> 
               <a href="#" onclick="return false;">Notes<br></a>
            </li>
            <li id="side-timetable" class="active nav-link"> 
               <a href="#" onclick="return false;">Timetable<br></a>
            </li>
            <li id="side-friends"   class="active nav-link"> 
               <a href="#" onclick="return false;">Friends<br></a>
            </li>
            <li id='side-map'       class="active nav-link"> 
               <a href="#" onclick="return false;">Map<br></a>
            </li>
            <li id="side-settings"  class="active nav-link"> 
               <a href="#" onclick="return false;">Settings<br></a>
            </li>
            <li id='side-logout'    class="active nav-link"> 
               <a href="#" onclick="return false;">Logout<br></a>
            </li>
         </ul>
      </div>
      <div id="home" class="beside">
         <!-- Burger -->
         <div class="row py-3">
            <!-- Calender Body -->
            <div class="col offset-2" id="main">
               <h2>Time Table</h2>
               <table id="timetable1">
                  <tr>
                     <th>Sunday</th>
                     <th>Monday</th>
                     <th>Tuesday</th>
                     <th>Wednesday</th>
                     <th>Thursday</th>
                     <th>Friday</th>
                     <th>Saturday</th>
                  </tr>
                  <tr>
                     <td>27</td>
                     <td>28</td>
                     <td>29</td>
                     <td>30</td>
                     <td>31</td>
                     <td>1</td>
                     <td>2</td>
                  </tr>
                  <tr>
                     <td>3</td>
                     <td>4</td>
                     <td>5</td>
                     <td>6</td>
                     <td>7</td>
                     <td>8</td>
                     <td>9</td>
                  </tr>
                  <tr>
                     <td>10</td>
                     <td>11</td>
                     <td>12</td>
                     <td>13</td>
                     <td>14</td>
                     <td>15</td>
                     <td>16</td>
                  </tr>
                  <tr>
                     <td>17</td>
                     <td>18</td>
                     <td>19</td>
                     <td>20</td>
                     <td>21</td>
                     <td>22</td>
                     <td>23</td>
                  </tr>
                  <tr>
                     <td>24</td>
                     <td>25</td>
                     <td>26</td>
                     <td>27</td>
                     <td>28</td>
                     <td>1</td>
                     <td>2</td>
                  </tr>
               </table>
               <!-- Side Buttons -->
            </div>
         </div>
      </div>
      <!-- Map page
         ----------------------------------------------------------
         -->
      <div id="map"  class="beside">
         <h1 id="mapTitle"></h1>
         <!-- Our map image -->
         <div id="mapContainer">
            <!-- The map image -->
            <img id="mapImg" />
            <!-- Link Buttons -->
            <table id="mapButtons">
            </table>
         </div>
         <div>
            <table id="foodTable"></table>
         </div>
      </div>
      <!-- Account page
         ----------------------------------------------------------
         -->
      <div id="account" class="beside">
         <h1>Account</h1>
      </div>
      <!-- Note page
         ----------------------------------------------------------
         -->
      <div id="note" class="beside">
         <h1>Notes</h1>
      </div>
      <!-- Friends page
         ----------------------------------------------------------
         -->


      <div id="friends" class="beside">
         <h3>Search For Friend:</h3><br>
         <form class="form-inline md-form mr-auto mb-4">
               <input id="SearchBar"class="form-control mr-sm-2" type="text" placeholder="Search" aria-label="Search">
               <button id="Search-button" class="btn btn-outline-warning btn-rounded btn-sm my-0">Search</button>
         </form>
         <!-- Our map image -->
         <div >
            <h2>Friends</h2>
            <table id='friend-list'>
            </table>
         </div>
         <div >
            <h2>Requests</h2>
            <table id='pending-list'>
            </table>
         </div>
         <div >
            <h2>Blocked</h2>
            <table id='blocked-list'>
            </table>
         </div>
      </div>


      <!-- Timetable Page page ---------------------------------------------------------- -->
      <div id="tt" class="beside">
         <div id="search-container" class="inline">
         <div id="course-container">
         </div>
         <div id="searchbar-container">
            <input type="text" id="searchbar" placeholder="Search..">
         </div>
         <div id="criteria" class="inline">
            <select name="session">
               <option value="fall/winter">Fall/Winter</option>
               <option value="summer">Summer</option>
            </select>
            <select name="semester">
               <option value="F">First</option>
               <option value="S">Second</option>
            </select>
         </div>
         <div id="search-results-container">
            <table id="courses"></table>
         </div>


         <script>
            const $searchbar = document.querySelector('#searchbar');
            const $table = document.querySelector('#courses');
            const $courseinfo = document.querySelector('#course-container');
            const $session = document.querySelector('select[name=\'session\']');
            const $semester = document.querySelector('select[name=\'semester\']');
            
            const courseHandler = function(e){
               for(var i = 0, row; row = $table.rows[i]; i++) {
                  for(var j = 0, col; col = row.cells[j]; j++) {
                     col.style.backgroundColor = "white";
                  }
               }
               e.target.style.backgroundColor = "grey";
               var data = {
                     "code": e.target.innerHTML.substring(0, 8),
                     "session": $session.value,
                     "semester": $semester.value
               }
               $.getJSON("http://localhost:8080/courses/", data, function(courses){ //get request for single course
                  console.log(courses);
                  var course = courses[0];
                  text = "<p>" + course.code + course.semester + "<br>";
                  text += course.name + "<br><br></p>";
                  text += course.description + "</div>";
                  text += "<div><table name=\"lectures\">"; //make post request for enrolling
                  for(var i = 0; i < course.lectures.length; i++){
                     lecture = course.lectures[i];
                     text += "<tr><td><input type=\"radio\" name=\"lecture\" value=\"" + i + "\"><label>LEC" + lecture.section + "</label></td><td><p>";
                     for(var j = 0; j < lecture.timings.length; j++){
                        timing = lecture.timings[j];
                        text += timing[0] + " " + timing[1] + "-" + timing[2] + "<br>";
                     }
                     text += "</td></tr>";
                  }
                  for(var i = 0; i < course.tutorials.length; i++){
                     tutorial = course.tutorials[i];
                     text += "<tr><td><input type=\"radio\" name=\"tutorial\" value=\"" + i + "\"><label>TUT" + tutorial.section + "</label></td><td><p>";
                     for(var j = 0; j < tutorial.timings.length; j++){
                        timing = tutorial.timings[j];
                        text += timing[0] + " " + timing[1] + "-" + timing[2] + "<br>";
                     }
                     text += "</td></tr>";
                  }
                  for(var i = 0; i < course.practicals.length; i++){
                     practical = course.practicals[i];
                     text += "<tr><td><input type=\"radio\" name=\"practical\" value=\"" + i + "\"><label>PRA" + practical.section + "</label></td><td><p>";
                     for(var j = 0; j < practical.timings.length; j++){
                        timing = practical.timings[j];
                        text += timing[0] + " " + timing[1] + "-" + timing[2] + "<br>";
                     }
                     text += "</td></tr>";
                  }
                  $.getJSON("http://localhost:8080/timetable/exists", data, function(result){
                     if(result){
                        text += "</table><input type=\"submit\" value=\"Modify course\" name=\"enrol\">";
                        text += "<input type=\"submit\" value=\"Unenrol in course\" name=\"unenrol\"></div>";
                        $courseinfo.innerHTML = text;
                        
                        unenrolBtn = document.querySelector('input[name=\'unenrol\']');
                        if(unenrolBtn){
                           console.log(data);
                           unenrolBtn.onclick = function(element){
                                $.ajax({
                                 url: "http://localhost:8080/timetable/",
                                 type: "DELETE",
                                 data: JSON.stringify(data),
                                 dataType: 'json',
                                 contentType: 'application/json',
                                 success: function(result){
                                    console.log(result);
                                    unenrolBtn.parentNode.removeChild(unenrolBtn);
                                    document.querySelector('input[name=\'enrol\']').value = "Enrol in course";
                                      var timetable = document.getElementById("timetable");
                                      reload();
                                 },
                                 error: function(err){
                                    console.log(err);
                                 }
                                });
                           };
                        }
                     }else{
                        text += "</table><input type=\"submit\" value=\"Enrol in course\" name=\"enrol\"></div>";
                        $courseinfo.innerHTML = text;
                     }
                     enrolBtn = document.querySelector('input[name=\'enrol\']');
                     if(enrolBtn){
                        enrolBtn.onclick = function(element){
                           var lecture = -1;
                           document.querySelectorAll('input[name=\'lecture\']').forEach(function(radio){
                              if(radio.checked){
                                 lecture = radio.value;
                                 return;
                              }
                           });
                           if(lecture === -1){
                              Alert("Choose a lecture section.");
                              return;
                           }
                           var tutorial = {};
                           document.querySelectorAll('input[name=\'tutorial\']').forEach(function(radio){
                              if(radio.checked){
                                 tutorial = course.tutorials[radio.value];
                                 return;
                              }
                           });
                           var practical = {};
                           document.querySelectorAll('input[name=\'practical\']').forEach(function(radio){
                              if(radio.checked){
                                 practical = course.practicals[radio.value];
                                 return;
                              }
                           });
                             var newCourse = {
                                 "code": course.code,
                                 "session": course.session,
                                 "semester": course.semester,
                                 "name": course.name,
                                 "description": course.description,
                                 "lecture": course.lectures[lecture],
                                 "tutorial": tutorial,
                                 "practical": practical
                             };
                             $.ajax({
                              url: "http://localhost:8080/timetable/",
                              type: "POST",
                              data: JSON.stringify(newCourse),
                              dataType: 'json',
                              contentType: 'application/json',
                              success: function(result){
                                 enrolBtn.value = "Modify course";
                                 enrolBtn.insertAdjacentHTML("afterend", "<input type=\"submit\" value=\"Unenrol in course\" name=\"unenrol\">");
                                 unenrolBtn = document.querySelector('input[name=\'unenrol\']');
                                 if(unenrolBtn){
                                    console.log(data);
                                    unenrolBtn.onclick = function(element){
                                         $.ajax({
                                          url: "http://localhost:8080/timetable/",
                                          type: "DELETE",
                                          data: JSON.stringify(data),
                                          dataType: 'json',
                                          contentType: 'application/json',
                                          success: function(result){
                                             console.log(result);
                                             unenrolBtn.parentNode.removeChild(unenrolBtn);
                                             enrolBtn.value = "Enrol in course";
                                               var timetable = document.getElementById("timetable");
                                               reload();
                                          },
                                          error: function(err){
                                             console.log(err);
                                          }
                                         });
                                    };
                                 }
                                 console.log(result);
                                   var timetable = document.getElementById("timetable");
                                   reload();
                              },
                              error: function(err){
                                 console.log(err);
                              }
                             });
                        }
                     }
                  });
               });
            }
            
            const typeHandler = function(e){
               if(e.target.value === ""){
                  $table.innerHTML = "";
                  return;
               }
               data = {
                     "code": e.target.value,
                     "session": $session.value,
                     "semester": $semester.value
               }
               $.getJSON("http://localhost:8080/courses/", data, function(courses){ //get request for all matching courses
                  console.log(courses);
                  text = "";
                  for(var key in courses){
                     course = courses[key];
                     text += "<tr><td class=\"course\">" + course.code + course.semester + "</td></tr>";
                  }
                  $table.innerHTML = text;
                  
                  document.querySelectorAll('.course').forEach(function(element){
                     element.addEventListener('click', courseHandler);
                  });
               });
            }
            
            $session.oninput = function(){
               $searchbar.dispatchEvent(new Event('input'));
               reload();
            }
            $semester.oninput = function(){
               $searchbar.dispatchEvent(new Event('input'));
               reload();
            }
            $searchbar.addEventListener('input', typeHandler);
            $searchbar.addEventListener('propertyChange', typeHandler);
         </script>
      </div>
      <div id="timetable-container" class="inline">
         <table id="timetable"></table>
         <script>
            var days = ["", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];
            var text = "<tr>";
            for(var i = 0; i < 6; i++){
               text += "<th>" + days[i] + "</th>";
            }
            text += "</tr>"; 
            for(var i = 8; i < 23; i++){
               text += "<tr>";
               if(i < 13){
                  text += "<th class=\"time\">" + i + ":00";
               }else{
                  text += "<th class=\"time\">" + (i - 12) + ":00"; 
               }
               for(var j = 0; j < 5; j++){
                  text += "<td class=\"timeslot\"></td>";
               }
               text += "</tr>"
            }
            var timetable = document.getElementById("timetable");
            timetable.innerHTML = text;
              reload();
         </script>
      </div>
      </div>
      <!-- Calender Page page ---------------------------------------------------------- -->
      <div id="cal" class="beside">
         <h1>Calendar</h1>
      </div>


      <div id="warn" class="alert alert-warning alert-dismissible fade show" role="alert">
         <strong>Warning!</strong><span id="warnMesg"></span>
         <button type="button" class="close" data-dismiss="alert" aria-label="Close">
         <span aria-hidden="true">&times;</span>
         </button>
      </div>
      <div id="success-msg" class="alert alert-success alert-dismissible fade show" role="alert">
         <strong>Sucess</strong><span id="sucMesg"></span>
         <button type="button" class="close" data-dismiss="alert" aria-label="Close">
         <span aria-hidden="true">&times;</span>
         </button>
      </div>
   </body>
</html>

